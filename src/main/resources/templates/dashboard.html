<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>User Dashboard</title>
    <style>
        body{font-family:Arial,sans-serif;margin:2rem;background:#f9f9f9}
        h2{color:#333}
        .dashboard-container{display:flex;gap:2rem}
        .section{background:#fff;border:1px solid #ddd;padding:1rem 1.5rem;border-radius:6px;
                 box-shadow:0 0 5px rgba(0,0,0,.1);flex:1}
        .section h3{margin-top:0;color:#555;border-bottom:1px solid #eee;padding-bottom:.5rem}
        button{margin-top:1rem;padding:.5rem 1rem;font-size:1rem;cursor:pointer;border:none;
               border-radius:4px;background:#007bff;color:#fff}
        button:hover{background:#0056b3}
        table{width:100%;border-collapse:collapse;margin-top:1rem}
        th,td{border:1px solid #ddd;padding:.5rem;text-align:left}
        th{background:#f4f4f4}
        #requestMessage{color:green;display:none;margin-top:1rem}
    </style>
</head>
<body>

<h2>User Dashboard</h2>

<div class="dashboard-container">

    <!-- EXISTING LEAVE REQUESTS -------------------------------------------------->
    <div class="section">
        <h3>Current Leave Requests</h3>
        <table id="leaveTable">
            <thead>
            <tr>
                <th>Leave Reason</th><th>Start Date</th><th>End Date</th><th>Status</th>
            </tr>
            </thead>
            <tbody><!-- rows inserted here --></tbody>
        </table>
    </div>

    <!-- NEW LEAVE REQUEST FORM -------------------------------------------------->
    <div class="section">
        <h3>Make Leave Request</h3>

        <form id="leaveRequestForm">
            <label for="leaveType">Leave Reason:</label><br>
            <input id="leaveType" type="text" placeholder="e.g. Sick, Vacation" required><br><br>

            <label for="startDate">Start Date:</label><br>
            <input id="startDate" type="date" required><br><br>

            <label for="endDate">End Date:</label><br>
            <input id="endDate" type="date" required><br><br>

            <button type="submit">Submit Request</button>
        </form>

        <p id="requestMessage"></p>
    </div>
</div>

<script>
    /* ---------- helpers ---------- */
    const token = localStorage.getItem('jwt');
    const apiBase = 'http://localhost:8081';

    /* add a row to the table */
    function addLeaveRow({ leave_reason, leave_start_date, leave_end_date, leave_status }) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${leave_reason}</td>
        <td>${leave_start_date}</td>
        <td>${leave_end_date}</td>
        <td>${leave_status}</td>`;
      document.querySelector('#leaveTable tbody').appendChild(tr);
    }

    /* ---------- load existing leaves on page load ---------- */
    async function loadMyLeaves() {
      if (!token) {
        alert('Please log in first.'); window.location.href = '/pages/login'; return;
      }
      try {
        const res = await fetch(`${apiBase}/user/myLeaveRequests`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          console.error('Failed to load leaves:', res.status);
          return;
        }
        const leaves = await res.json(); // expecting array
        leaves.forEach(addLeaveRow);
      } catch (err) {
        console.error('Error fetching leaves:', err);
      }
    }

    /* ---------- submit new leave ---------- */
    document.getElementById('leaveRequestForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const leaveType = document.getElementById('leaveType').value.trim();
      const startDate = document.getElementById('startDate').value;
      const endDate   = document.getElementById('endDate').value;

      if (!leaveType || !startDate || !endDate) { alert('Fill all fields'); return; }

      if (!token) { alert('Please log in first.'); window.location.href='/pages/login'; return; }

      try {
        const res = await fetch(`${apiBase}/user/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': `Bearer ${token}`
          },
          body: new URLSearchParams({ reason: leaveType, startDate, endDate })
        });

        if (res.ok) {
          const leave = await res.json();       // backend returns saved Leave
          addLeaveRow(leave);                   // show immediately in table
          const msg = document.getElementById('requestMessage');
          msg.textContent = 'Leave request submitted!';
          msg.style.display = 'block';
          this.reset();
        } else if (res.status === 401) {
          alert('Session expired â€“ log in again.');
          window.location.href = '/pages/login';
        } else {
          const text = await res.text();
          alert('Request failed: ' + text);
        }
      } catch (err) {
        console.error('Error submitting request:', err);
        alert('Network error submitting request.');
      }
    });

    /* run on page load */
    loadMyLeaves();
</script>

</body>
</html>










